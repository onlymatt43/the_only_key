<!DOCTYPE html>
<html>
<head>
    <title>Admin QR Generator</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { background: #222; color: #fff; font-family: Arial, sans-serif; text-align: center; padding-top: 40px; }
        .form-box { background: #333; display: inline-block; padding: 32px 24px; border-radius: 12px; box-shadow: 0 2px 16px #0006; }
        input, select { margin: 8px 0; padding: 8px; border-radius: 6px; border: none; font-size: 1rem; }
        button { padding: 10px 24px; border-radius: 6px; border: none; background: #0a8; color: #fff; font-weight: bold; cursor: pointer; margin-top: 12px; }
        #qrcode { margin-top: 24px; }
    </style>
</head>
<body>
    <div class="form-box">
        <h2>Générateur de QR (admin)</h2>
        <form id="qrForm" onsubmit="return false;">
            <label>Token (aléatoire, personnalisé ou <b>:roi</b>):<br><input type="text" id="token" required placeholder=":roi ou hash"></label><br>
            <button type="button" onclick="genToken()">Générer un token aléatoire</button>
            <button type="button" onclick="setRoi()">QR :roi (maître)</button><br>
            <label>Durée:
                <input type="number" id="duree" min="1" value="5" required>
                <select id="unite">
                    <option value="s">seconde(s)</option>
                    <option value="m">minute(s)</option>
                    <option value="h">heure(s)</option>
                    <option value="d">journée(s)</option>
                </select>
            </label><br>
            <label>Page à débloquer :
                <select id="page">
                    <option value="page_unlock">Contenu principal</option>
                    <option value="play_game">Jeu</option>
                    <option value="acheter">Acheter</option>
                    <!-- Ajoutez d'autres pages ici si besoin -->
                </select>
            </label><br>
            <button onclick="generateQR()">Générer QR</button>
        </form>
        <div id="qrtext" style="margin-top:16px;"></div>
        <div id="qrcode"></div>
    <div style="margin-top:32px;">
        <h3>Générer un QR code d'accès direct (auto-identification)</h3>
        <label>Rôle :
            <select id="role-select">
                <option value=":roi">Roi (contrôle total)</option>
                <option value="admin">Admin (gestion contenu)</option>
                <option value="user">User (accès simple)</option>
            </select>
        </label>
        <label style="margin-left:16px;">Token personnalisé :
            <input type="text" id="role-token" placeholder="Laisser vide pour générer" style="width:180px;">
        </label>
        <button type="button" onclick="generateRoleQR()">Générer QR d'accès</button>
        <div id="role-qr-link" style="margin-top:8px;"></div>
        <canvas id="role-qr-canvas" width="200" height="200" style="margin-top:8px;"></canvas>
    </div>
        <div style="margin-top:32px;">
            <h3>QR code universel (admin & user)</h3>
            <div id="universal-qr-text" style="margin-bottom:8px;">QR universel : {{ universal_qr_url }}</div>
            <canvas id="universal-qr-canvas" width="200" height="200"></canvas>
        </div>
        {% if qr_code_roi %}
        <div style="margin-top:32px;">
            <h3>QR code admin (permanent, compatibilité)</h3>
            <div id="roi-qr-text" style="margin-bottom:8px;">QR à scanner (admin) : {{ qr_code_roi }}</div>
            <canvas id="roi-qr-canvas" width="200" height="200"></canvas>
        </div>
        {% endif %}
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script>
    function genToken() {
        fetch('/gen_token_hash', {method:'POST'})
        .then(r=>r.json()).then(data=>{
            document.getElementById('token').value = data.token;
        });
    }
    function setRoi() {
        document.getElementById('token').value = ':roi';
    }
    function generateQR() {
        var token = document.getElementById('token').value.trim();
        var duree = document.getElementById('duree').value;
        var unite = document.getElementById('unite').value;
        var page = document.getElementById('page').value;
        if (!token) return;
        var qrdata = token + ':' + duree + unite + ':' + page;
        document.getElementById('qrtext').innerText = 'QR à scanner: ' + qrdata;
        var qr = new QRious({
            element: document.getElementById('qrcode'),
            value: qrdata,
            size: 256,
            background: '#fff',
            foreground: '#222'
        });
    }
    // Génère le QR code universel
    window.addEventListener('DOMContentLoaded', function() {
        var universalQr = new QRious({
            element: document.getElementById('universal-qr-canvas'),
            value: '{{ universal_qr_url }}',
            size: 200,
            background: '#fff',
            foreground: '#222'
        });
        {% if qr_code_roi %}
        var roiQr = new QRious({
            element: document.getElementById('roi-qr-canvas'),
            value: '{{ qr_code_roi }}',
            size: 200,
            background: '#fff',
            foreground: '#222'
        });
        {% endif %}
    });

    // Génère un QR code d'accès direct pour un rôle donné
    function generateRoleQR() {
        var role = document.getElementById('role-select').value;
        var token = document.getElementById('role-token').value.trim();
        // Si pas de token, on en génère un via l'API
        if (!token && role !== ':roi') {
            fetch('/gen_token_hash', {method:'POST'})
            .then(r=>r.json()).then(data=>{
                document.getElementById('role-token').value = data.token;
                showRoleQR(role, data.token);
            });
        } else {
            showRoleQR(role, token || ':roi');
        }
    }

    function showRoleQR(role, token) {
        var baseUrl = window.location.origin;
        var url = '';
        if (role === ':roi') {
            url = baseUrl + '/roi_login?token=' + encodeURIComponent(token);
        } else if (role === 'admin') {
            url = baseUrl + '/admin_login?token=' + encodeURIComponent(token);
        } else {
            url = baseUrl + '/user_login?token=' + encodeURIComponent(token);
        }
        document.getElementById('role-qr-link').innerHTML = 'Lien d\'accès : <a href="' + url + '" target="_blank">' + url + '</a>';
        var qr = new QRious({
            element: document.getElementById('role-qr-canvas'),
            value: url,
            size: 200,
            background: '#fff',
            foreground: '#222'
        });
    });
    </script>
</body>
</html>
